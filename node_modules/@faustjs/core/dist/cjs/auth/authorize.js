"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ensureAuthorization = void 0;
require("isomorphic-fetch");
const isString_1 = __importDefault(require("lodash/isString"));
const config_1 = require("../config");
const utils_1 = require("../utils");
const accessToken_1 = require("./client/accessToken");
/* eslint-disable consistent-return */
/**
 * Checks for an existing Access Token and returns one if it exists. Otherwise returns
 * an object containing a redirect URI to send the client to for authorization.
 *
 * @export
 * @param {string} EnsureAuthorizationOptions
 * @returns {(string | { redirect: string })}
 */
async function ensureAuthorization(options) {
    const { wpUrl } = (0, config_1.config)();
    const { redirectUri, loginPageUri } = options || {};
    // Get the authorization code from the URL if it exists
    const code = typeof window !== 'undefined'
        ? (0, utils_1.getQueryParam)(window.location.href, 'code')
        : undefined;
    const unauthorized = {};
    if ((0, isString_1.default)(redirectUri)) {
        unauthorized.redirect = `${wpUrl}/generate?redirect_uri=${encodeURIComponent(redirectUri)}`;
    }
    if ((0, isString_1.default)(loginPageUri)) {
        unauthorized.login = loginPageUri;
    }
    const token = await (0, accessToken_1.fetchAccessToken)(code);
    if (!token) {
        return unauthorized;
    }
    if (code) {
        window.history.replaceState({}, document.title, (0, utils_1.removeURLParam)(window.location.href, 'code'));
    }
    return true;
}
exports.ensureAuthorization = ensureAuthorization;
/* eslint-enable consistent-return */
